name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Decode Android keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
        run: |
          if [ -z "$KEYSTORE_BASE64" ] || [ -z "$KEY_ALIAS" ] || [ -z "$KEY_PASSWORD" ] || [ -z "$STORE_PASSWORD" ]; then
            echo "Missing Android signing secrets."
            exit 1
          fi

          echo "$KEYSTORE_BASE64" | base64 --decode > android/upload-keystore.jks

          cat > android/key.properties <<EOF
          storePassword=$STORE_PASSWORD
          keyPassword=$KEY_PASSWORD
          keyAlias=$KEY_ALIAS
          storeFile=../upload-keystore.jks
          EOF

      - name: Build Android APK
        run: flutter build apk --release

      - name: Archive Android artifact
        run: |
          mkdir -p dist
          cp build/app/outputs/flutter-apk/app-release.apk dist/AnimeShelf-${GITHUB_REF_NAME}-android.apk

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: dist/*.apk
          if-no-files-found: error

  build-linux:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            cmake g++ ninja-build libgtk-3-dev liblzma-dev

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Linux bundle
        env:
          CC: gcc
          CXX: g++
        run: flutter build linux --release

      - name: Archive Linux artifact
        run: |
          mkdir -p dist
          tar -C build/linux/x64/release -czf dist/AnimeShelf-${GITHUB_REF_NAME}-linux-x64.tar.gz bundle

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-tarball
          path: dist/*.tar.gz
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows release
        run: flutter build windows --release

      - name: Install NSIS
        run: choco install nsis -y

      - name: Build NSIS installer
        shell: cmd
        run: |
          if not exist dist mkdir dist
          makensis /DVERSION=%GITHUB_REF_NAME% /DOUTPUT_FILE=dist\AnimeShelf-%GITHUB_REF_NAME%-windows-x64-setup.exe windows\installer\installer.nsi

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: dist/*.exe
          if-no-files-found: error

  create-release:
    runs-on: ubuntu-latest
    needs:
      - build-android
      - build-linux
      - build-windows

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: "*"
          merge-multiple: true

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v2
        with:
          name: AnimeShelf ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            dist/*.apk
            dist/*.tar.gz
            dist/*.exe
